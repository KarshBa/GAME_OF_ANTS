<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conway's Game of Life with Langton's Ant</title>
  <style>
    html, body { margin:0; height:100%; width:100%; overflow:hidden; background:#000; font-family:system-ui,sans-serif; }
    canvas { display:block; position:absolute; top:0; left:0; width:100vw; height:100vh; background:#000; image-rendering:pixelated; }
    .uiBox { position:fixed; z-index:10; background:rgba(0,0,0,0.7); color:#fff; padding:6px 10px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.6); display:flex; align-items:center; gap:6px; flex-wrap:wrap; font-size:14px; user-select:none; }
    #speedBox { top:10px; left:50%; transform:translateX(-50%); }
    #controlBox { top:58px; left:10px; }
    button { cursor:pointer; padding:2px 10px; border:1px solid #aaa; border-radius:4px; background:#333; color:#fff; }
    button:hover { background:#555; }
    input[type=range] { vertical-align:middle; }
    @media (max-width:600px) { .uiBox { font-size:12px; gap:4px; } #speedBox { top:6px; } #controlBox { top:46px; } }
    #setupModal { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); display:none; align-items:center; justify-content:center; flex-direction:column; z-index:20; color:#fff; } align-items:center; justify-content:center; flex-direction:column; z-index:20; color:#fff; }
    #setupGrid { display:grid; grid-template-columns:repeat(5,30px); grid-template-rows:repeat(5,30px); gap:4px; margin-bottom:12px; }
    .setupCell { width:30px; height:30px; background:#000; border:1px solid #555; cursor:pointer; }
    #colorPicker { margin-left:8px; cursor:pointer; width:40px; height:40px; border:none; padding:0; }
  </style>
</head>
<body>
  <div id="setupModal">
    <h2>Select a 5×5 Starting Pattern & Color</h2>
    <div style="display:flex; align-items:center;">
      <div id="setupGrid"></div>
      <div style="display:flex; flex-direction:column; align-items:center; margin-left:16px;">
        <label for="colorPicker">Cell Color:</label>
        <input type="color" id="colorPicker" value="#ffffff" />
      </div>
    </div>
    <button id="setupStartBtn">Start Game</button>
  </div>
  <div id="speedBox" class="uiBox">
    <label for="speedSlider">Speed:</label>
    <input type="range" id="speedSlider" min="0.1" max="50" step="0.1" value="0.25" />
    <span id="speedVal">0.25</span> gen/sec
  </div>
  <div id="controlBox" class="uiBox">
    <button id="startPauseBtn">Start</button>
    <button id="clearBtn">Clear</button>
    <span id="pointsDisplay">Points: 0</span>
    <button id="addAntBtn" style="display:none;">Add Ant</button>
    <button id="add5AntBtn" style="display:none;">Add 5 Ants</button>
  </div>
  <canvas id="lifeCanvas"></canvas>
  <script>
    const canvas = document.getElementById('lifeCanvas');
    const ctx = canvas.getContext('2d');
    const speedSlider = document.getElementById('speedSlider');
    const speedVal = document.getElementById('speedVal');
    const startPauseBtn = document.getElementById('startPauseBtn');
    const clearBtn = document.getElementById('clearBtn');
    const setupModal = document.getElementById('setupModal');
    const setupGridEl = document.getElementById('setupGrid');
    const setupStartBtn = document.getElementById('setupStartBtn');
    const colorPicker = document.getElementById('colorPicker');
    const pointsDisplay = document.getElementById('pointsDisplay');
    const addAntBtn = document.getElementById('addAntBtn');
    const add5AntBtn = document.getElementById('add5AntBtn');

    const MAGENTA = '#ff00ff';
    const CYAN = '#00ffff';
    let bridgeColor;
    let liveColor;
    let cellColorMap = new Map();

    let cellSize = 10, cols, rows;
    let grid, nextGrid;
    let genPerSec = parseFloat(speedSlider.value);
    let isRunning = false, lastTime = 0;
    let setupPattern = new Array(25).fill(0);

    let ants = [];
    let antPoints = 0;
    let structurePositions = new Set();
    let prevStructures = new Set();
    const antColors = ['red','yellow','cyan','magenta','lime','orange'];

    // Highway: diagonal steps, width ±2
    const highwayDir = { dx:1, dy:1 };
    const highwayWidth = 2;
    const highwayLength = 100;

    function dims() { return { cols: Math.floor(canvas.width / cellSize), rows: Math.floor(canvas.height / cellSize) }; }
    function init(blank = true) {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const d = dims(); cols = d.cols; rows = d.rows;
      grid = new Array(cols * rows).fill(0);
      nextGrid = new Array(cols * rows).fill(0);
      cellColorMap.clear();
      if (!blank) randomize();
      drawGrid();
    }
    function randomize() { grid = grid.map(() => Math.random()<0.3?1:0); }
    function drawGrid() {
      ctx.fillStyle = '#000'; ctx.fillRect(0, 0, canvas.width, canvas.height);
      for (let y = 0; y < rows; y++) {
        for (let x = 0; x < cols; x++) {
          const i = y*cols + x;
          if (grid[i]) {
            ctx.fillStyle = cellColorMap.get(i) || liveColor;
            ctx.fillRect(x*cellSize, y*cellSize, cellSize, cellSize);
          }
        }
      }
    }
    function step() {
      for (let y=0; y<rows; y++) for (let x=0; x<cols; x++) {
        let n=0;
        for (let dy=-1; dy<=1; dy++) for (let dx=-1; dx<=1; dx++) if(dx||dy) {
          const nx=(x+dx+cols)%cols, ny=(y+dy+rows)%rows;
          n += grid[ny*cols + nx];
        }
        nextGrid[y*cols+x] = grid[y*cols+x] ? (n===2||n===3?1:0) : (n===3?1:0);
      }
      [grid,nextGrid] = [nextGrid,grid];
    }
    function detectStructures(o,n) { /* unchanged */ }
    function updateAnts() {
      // Bridge ants build highway
      ants.forEach(ant => {
        if (ant.mode === 'bridge') {
          // check proximity to other bridge ants
          const near = ants.some(b => b !== ant && b.mode === 'bridge' && Math.abs(b.x-ant.x)<=1 && Math.abs(b.y-ant.y)<=1);
          if (ant.stepIndex < highwayLength && !near) {
            // build width
            for (let w=-highwayWidth; w<=highwayWidth; w++) {
              const px = ant.x + w * highwayDir.dy;
              const py = ant.y - w * highwayDir.dx;
              const idx = ((py+rows)%rows)*cols + ((px+cols)%cols);
              grid[idx] = 1;
              cellColorMap.set(idx, bridgeColor);
            }
            // move diagonally
            ant.x = (ant.x + highwayDir.dx + cols) % cols;
            ant.y = (ant.y + highwayDir.dy + rows) % rows;
            ant.stepIndex++;
            return;
          } else {
            ant.mode = 'langton'; ant.dir = 0;
          }
        }
        // classic Langton
        const i = ant.y*cols + ant.x;
        const mapping = cellColorMap.get(i);
        if (mapping === bridgeColor) ant.dir = (ant.dir+3)%4;
        else {
          if (grid[i]) { ant.dir=(ant.dir+1)%4; grid[i]=0; cellColorMap.delete(i); if (structurePositions.has(i)){antPoints++; pointsDisplay.textContent=`Points: ${antPoints}`;} }
          else       { ant.dir=(ant.dir+3)%4; grid[i]=1; }
        }
        if (ant.dir===0) ant.y=(ant.y-1+rows)%rows;
        else if (ant.dir===1) ant.x=(ant.x+1)%cols;
        else if (ant.dir===2) ant.y=(ant.y+1)%rows;
        else ant.x=(ant.x-1+cols)%cols;
      });
      // Proximity collision unchanged
      const toRemove = new Set(), newAnts = [];
      for(let i=0;i<ants.length;i++){
        for(let j=i+1;j<ants.length;j++){
          const a=ants[i], b=ants[j];
          if(Math.abs(a.x-b.x)<=1 && Math.abs(a.y-b.y)<=1){
            toRemove.add(i); toRemove.add(j);
            const sx=Math.round((a.x+b.x)/2), sy=Math.round((a.y+b.y)/2);
            newAnts.push({ x:sx, y:sy, dir:0, mode:'bridge', stepIndex:0, color:antColors[ants.length%antColors.length] });
          }
        }
      }
      ants = ants.filter((_, idx) => !toRemove.has(idx)); ants.push(...newAnts);
      updateAddAntUI();
    }
    function drawAnts(){ ants.forEach(ant=>{ ctx.fillStyle=ant.color; ctx.fillRect(ant.x*cellSize,ant.y*cellSize,cellSize,cellSize); }); }
    function updateAddAntUI(){ /* unchanged */ }
    /* rest unchanged */
  </script>
</body>
</html>
