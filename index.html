<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Conway's Game of Life with Langton's Ant</title>
  <style>
    html, body { margin:0; height:100%; width:100%; overflow:hidden; background:#000; font-family:system-ui,sans-serif; }
    canvas { display:block; position:absolute; top:0; left:0; width:100vw; height:100vh; background:#000; image-rendering:pixelated; }
    .uiBox { position:fixed; z-index:10; background:rgba(0,0,0,0.7); color:#fff; padding:6px 10px; border-radius:6px; box-shadow:0 1px 4px rgba(0,0,0,0.6); display:flex; align-items:center; gap:6px; flex-wrap:wrap; font-size:14px; user-select:none; }
    #speedBox { top:10px; left:50%; transform:translateX(-50%); }
    #controlBox { top:58px; left:10px; }
    button { cursor:pointer; padding:2px 10px; border:1px solid #aaa; border-radius:4px; background:#333; color:#fff; }
    button:hover { background:#555; }
    input[type=range] { vertical-align:middle; }
    @media (max-width:600px) { .uiBox { font-size:12px; gap:4px; } #speedBox { top:6px; } #controlBox { top:46px; } }
    #setupModal { position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; flex-direction:column; z-index:20; color:#fff; }
    #setupGrid { display:grid; grid-template-columns:repeat(5,30px); grid-template-rows:repeat(5,30px); gap:4px; margin-bottom:12px; }
    .setupCell { width:30px; height:30px; background:#000; border:1px solid #555; cursor:pointer; }
    #colorPicker { margin-left:8px; cursor:pointer; width:40px; height:40px; border:none; padding:0; }
  </style>
</head>
<body>
  <div id="setupModal">
    <h2>Select a 5Ã—5 Starting Pattern & Color</h2>
    <div style="display:flex; align-items:center;">
      <div id="setupGrid"></div>
      <div style="display:flex; flex-direction:column; align-items:center; margin-left:16px;">
        <label for="colorPicker">Cell Color:</label>
        <input type="color" id="colorPicker" value="#ffffff" />
      </div>
    </div>
    <button id="setupStartBtn">Start Game</button>
  </div>
  <div id="speedBox" class="uiBox">
    <label for="speedSlider">Speed:</label>
    <input type="range" id="speedSlider" min="0.1" max="50" step="0.1" value="0.25" />
    <span id="speedVal">0.25</span> gen/sec
  </div>
  <div id="controlBox" class="uiBox">
    <button id="startPauseBtn">Start</button>
    <button id="clearBtn">Clear</button>
    <span id="pointsDisplay">Points: 0</span>
    <button id="addAntBtn" style="display:none;">Add Ant</button>
    <button id="add5AntsBtn" style="display:none;">Add 5 Ants</button>
  </div>
  <canvas id="lifeCanvas"></canvas>
  <script>
    const COST_SINGLE = 100;
    const COST_FIVE = COST_SINGLE * 5;
    const canvas = document.getElementById('lifeCanvas');
    const ctx = canvas.getContext('2d');
    const speedSlider = document.getElementById('speedSlider');
    const speedVal = document.getElementById('speedVal');
    const startPauseBtn = document.getElementById('startPauseBtn');
    const clearBtn = document.getElementById('clearBtn');
    const setupModal = document.getElementById('setupModal');
    const setupGridEl = document.getElementById('setupGrid');
    const setupStartBtn = document.getElementById('setupStartBtn');
    const colorPicker = document.getElementById('colorPicker');
    const pointsDisplay = document.getElementById('pointsDisplay');
    const addAntBtn = document.getElementById('addAntBtn');
    const add5AntsBtn = document.getElementById('add5AntsBtn');

    const MAGENTA = '#ff00ff';
    const CYAN = '#00ffff';
    let bridgeColor, liveColor;
    let cellColorMap = new Map();

    let cellSize = 10, cols, rows;
    let grid, nextGrid;
    let genPerSec = parseFloat(speedSlider.value);
    let isRunning = false, lastTime = 0;
    let setupPattern = new Array(25).fill(0);

    let ants = [];
    let antPoints = 0;
    let structurePositions = new Set();
    let prevStructures = new Set();
    const antColors = ['red','yellow','cyan','magenta','lime','orange'];

    function dims() { return { cols: Math.floor(canvas.width / cellSize), rows: Math.floor(canvas.height / cellSize) }; }
    function init(blank = true) {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      ({ cols, rows } = dims());
      grid = new Array(cols * rows).fill(0);
      nextGrid = new Array(cols * rows).fill(0);
      cellColorMap.clear();
      if (!blank) randomize();
      drawGrid();
    }
    function randomize() { grid = grid.map(() => Math.random()<0.3?1:0); }
    function drawGrid() {
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,canvas.width,canvas.height);
      for (let y=0;y<rows;y++) for (let x=0;x<cols;x++) {
        const i = y*cols+x;
        if (grid[i]) {
          ctx.fillStyle = cellColorMap.get(i) || liveColor;
          ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
        }
      }
    }
    function updateUI() {
      pointsDisplay.textContent = `Points: ${antPoints}`;
      addAntBtn.style.display = (antPoints >= COST_SINGLE) ? 'inline-block' : 'none';
      add5AntsBtn.style.display = (antPoints >= COST_FIVE) ? 'inline-block' : 'none';
    }
    addAntBtn.addEventListener('click',()=>{
      if (antPoints >= COST_SINGLE) {
        antPoints -= COST_SINGLE;
        ants.push(createLangtonAnt(cols, rows, ants.length));
        updateUI();
      }
    });
    add5AntsBtn.addEventListener('click',()=>{
      if (antPoints >= COST_FIVE) {
        antPoints -= COST_FIVE;
        for (let i=0; i<5; i++) ants.push(createLangtonAnt(cols, rows, ants.length));
        updateUI();
      }
    });
    function createLangtonAnt(cols, rows, idx) {
      return { x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows), dir:0, mode:'langton', bridgeSteps:0, bridgeLength:100, bridgeWidth:5, bridgeDx:1, bridgeDy:1, perpDx:-1, perpDy:1, color: antColors[idx % antColors.length] };
    }
    // ... rest of step, detectStructures, updateAnts, drawAnts, animate, setup etc unchanged ...

    // Initialize and show modal
    init(true); showModal(); updateUI(); requestAnimationFrame(animate);
  </script>
</body>
</html>
